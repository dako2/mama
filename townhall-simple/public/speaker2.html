<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iPhone PCM/WebM Audio Streaming</title>
</head>
<body>
  <h1>iPhone PCM/WebM Audio Streaming</h1>
  <button id="streamButton">ðŸŽ¤ Start Streaming</button>
  <p id="status">Status: Idle</p>
  
  <h2>Transcription</h2>
  <p id="transcriptionText">...</p>

  <h2>Translation</h2>
  <p id="translationText">...</p>

  <script src="scripts/audioStreamer.js"></script>
  <script src="scripts/webSocketHandler.js"></script>
  <script src="scripts/tts.js"></script>
  <script>
    let audioStreamer = null;
    let wsHandler = null;
    let streaming = false;

    function getWebSocketUrl() {
      return (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
    }

    async function startStreaming() {
      document.getElementById("status").innerText = "Status: Starting...";
      
      audioStreamer = new AudioStreamer();
      const format = AudioStreamer.getAudioFormat();

      wsHandler = new WebSocketHandler({
        onMessage: handleIncomingMessage,
        onError: (err) => console.log("App: WebSocket error:", err),
      });

      await wsHandler.connect(getWebSocketUrl(), format);
      await audioStreamer.start((audioData) => {
        wsHandler.send(audioData);
      });

      document.getElementById("status").innerText = "Status: Streaming...";
      document.getElementById("streamButton").innerText = "â¹ Stop Streaming";
      streaming = true;
    }

    function stopStreaming() {
      audioStreamer?.stop();
      wsHandler?.close();
      document.getElementById("status").innerText = "Status: Stopped";
      document.getElementById("streamButton").innerText = "ðŸŽ¤ Start Streaming";
      streaming = false;
    }

    document.getElementById("streamButton").addEventListener("click", () => {
      streaming ? stopStreaming() : startStreaming();
    });
  </script>
</body>
</html>
